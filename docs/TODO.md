# TODO - ui-gohan 開発タスク

## Phase 1: 環境構築（1週間）

### プロジェクトセットアップ

- [x] Expoプロジェクトの初期化
  - [x] `npx create-expo-app` でプロジェクト作成
  - [x] TypeScript設定
  - [x] .gitignore設定確認
  - [x] パッケージマネージャー設定（npm/yarn/pnpm）
- [x] ESLint/Prettier設定

### UIライブラリ導入

- [x] React Native Reusables セットアップ
  - [x] NativeWind (Tailwind CSS) インストール
  - [x] tailwind.config.js 作成
  - [x] 必要なコンポーネントをプロジェクトにコピー
  - [x] テーマ設定(カラースキーム、タイポグラフィ)
- [x] 基本コンポーネントの動作確認

### データベース・ORM設定

- [x] Turso Cloud セットアップ
  - [x] Tursoアカウント作成
  - [x] データベース作成
  - [x] 認証トークン取得
- [x] Drizzle ORM インストール
  - [x] `drizzle-orm` パッケージ追加
  - [x] `@libsql/client` パッケージ追加（Turso用）
  - [x] `drizzle-kit` インストール（マイグレーション用）
- [x] Drizzle 設定ファイル作成
  - [x] `drizzle.config.ts` 作成
  - [x] DB接続設定（ローカル・リモート両対応）

### 認証システム設定（Better Auth）

- [x] Better Auth インストール
  - [x] `better-auth` パッケージ追加
  - [x] `@better-auth/expo` パッケージ追加
- [x] Expo関連パッケージインストール
  - [x] `expo-secure-store` インストール
  - [x] `expo-linking` インストール（既存確認）
  - [x] `expo-web-browser` インストール（既存確認）
  - [x] `expo-constants` インストール（既存確認）
- [x] Metro Bundler設定
  - [x] `metro.config.js` 作成または更新
  - [x] `unstable_enablePackageExports` 追加
  - [x] キャッシュクリア実行
- [x] app.json 設定確認
  - [x] `scheme` 設定確認（ui-gohan）
  - [x] iOS `bundleIdentifier` 追加
  - [x] Android `package` 追加

### 開発環境整備

- [x] Jest セットアップ
  - [x] Jest設定ファイル作成
  - [x] テスト用ユーティリティ準備
- [x] 環境変数管理
  - [x] `.env` ファイル作成
  - [x] Turso接続情報設定

---

## Phase 2: MVP開発（6-8週間）

### 認証システム実装（Better Auth）

#### バックエンド構築

- [ ] Better Auth バックエンド設定
  - [x] `lib/auth.ts` 作成
  - [x] Drizzle Adapter 設定（`drizzleAdapter`）
  - [x] Anonymous プラグイン追加（ゲストログイン用）
  - [x] メール/パスワード認証有効化
  - [x] `trustedOrigins` 設定（`ui-gohan://`）
- [x] Expo API Routes 作成
  - [x] `app/api/auth/[...auth]+api.ts` 作成
  - [x] Better Auth ハンドラーマウント（GET, POST）
- [ ] メール送信設定
  - [x] Resend アカウント作成（推奨）
  - [x] API キー取得
  - [x] パスワードリセットメール設定

#### クライアント実装

- [x] Better Auth クライアント設定
  - [x] `lib/auth-client.ts` 作成
  - [x] `createAuthClient` 設定
  - [x] `expoClient` プラグイン追加
  - [x] `expo-secure-store` 統合
  - [x] baseURL 設定（開発・本番）

#### 認証画面実装

- [ ] ウェルカム画面（`app/(auth)/welcome.tsx`）
  - [ ] アプリ説明
  - [ ] ゲストとして始めるボタン（メイン）
  - [ ] ログインリンク
- [ ] ログイン画面（`app/(auth)/sign-in.tsx`）
  - [ ] メールアドレス入力
  - [ ] パスワード入力
  - [ ] ログインボタン
  - [ ] アカウント作成リンク
  - [ ] パスワードリセットリンク
  - [ ] ゲストとして始めるリンク
- [ ] アカウント作成画面（`app/(auth)/sign-up.tsx`）
  - [ ] 名前入力（任意）
  - [ ] メールアドレス入力
  - [ ] パスワード入力
  - [ ] パスワード確認入力
  - [ ] アカウント作成ボタン
  - [ ] ログイン画面へのリンク
- [ ] パスワードリセット画面（`app/(auth)/reset-password.tsx`）
  - [ ] メールアドレス入力
  - [ ] リセットメール送信ボタン
- [ ] 設定画面（ゲストユーザー向け）
  - [ ] ゲストユーザー表示
  - [ ] アカウント作成を促すバナー
  - [ ] アカウント作成ボタン
  - [ ] データバックアップ警告

#### 認証ガード実装

- [ ] Expo Router 認証ガード
  - [ ] `app/_layout.tsx` に認証チェック追加
  - [ ] `useSession` hook 使用
  - [ ] 初回起動時のウェルカム画面表示
  - [ ] ゲストユーザー/ログインユーザーの判定
  - [ ] ゲストユーザーはホーム画面へ
  - [ ] 未認証時はウェルカム画面へ
- [ ] ローディング状態の処理
  - [ ] セッション読み込み中の表示

#### ゲストログイン実装

- [ ] ゲストログイン機能
  - [ ] Anonymous 認証実装
  - [ ] 端末ごとの一意ID生成
  - [ ] ゲストユーザーのセッション管理
  - [ ] ゲストユーザー識別フラグ

### データベース設計・実装

#### スキーマ定義

- [ ] Drizzle ORMでスキーマ定義（`src/db/schema.ts`）
  - [ ] Better Auth テーブル（自動生成）
    - [ ] `user` テーブル
    - [ ] `session` テーブル
    - [ ] `account` テーブル（ソーシャルログイン用）
    - [ ] `verification` テーブル
  - [ ] `menus` テーブル定義
    - [ ] id (UUID)
    - [ ] userId (text, 外部キー) ← 追加
    - [ ] dayOfWeek (integer)
    - [ ] mealType (text)
    - [ ] dishName (text)
    - [ ] memo (text, nullable)
    - [ ] sortOrder (integer)
    - [ ] createdAt (timestamp)
    - [ ] updatedAt (timestamp)
  - [ ] インデックス設定（sortOrder, userId）
  - [ ] 外部キー制約設定（menus.userId → user.id）

#### マイグレーション

- [ ] 初回マイグレーション実行
  - [ ] `drizzle-kit generate` でマイグレーションファイル生成
  - [ ] `drizzle-kit push` でTurso Cloudに適用
- [ ] シードデータ作成（開発用）

#### データアクセス層

- [ ] DB接続クライアント実装（`src/db/client.ts`）
  - [ ] ローカルレプリカ設定
  - [ ] リモート接続設定
- [ ] CRUD操作の実装（認証済みユーザーのみ）
  - [ ] `createMenu(userId, data)` - 献立作成
  - [ ] `getMenus(userId)` - ユーザーの献立一覧取得
  - [ ] `getMenuById(userId, menuId)` - 献立詳細取得
  - [ ] `updateMenu(userId, menuId, data)` - 献立更新
  - [ ] `deleteMenu(userId, menuId)` - 献立削除
  - [ ] `reorderMenus(userId, menuIds)` - 並び替え（複数更新）
- [ ] 認証が必要なAPIリクエスト実装
  - [ ] `authClient.getCookie()` でトークン取得
  - [ ] リクエストヘッダーにCookie追加
  - [ ] エラーハンドリング（401 Unauthorized）

### 型定義

- [ ] TypeScript型定義（`src/types/`）
  - [ ] `Menu` インターフェース
  - [ ] `DayOfWeek` enum
  - [ ] `MealType` enum
  - [ ] API レスポンス型

### コア機能実装

#### ナビゲーション

- [ ] ナビゲーション構成を決定
  - [ ] タブナビゲーション or スタックナビゲーション
- [ ] React Navigation セットアップ
- [ ] 画面遷移実装

#### 画面実装

##### 1. ホーム画面（一週間献立リスト）

- [x] 画面レイアウト作成
- [x] 献立リストコンポーネント
  - [x] 日曜日〜土曜日の7日分表示（DaySectionコンポーネント化）
  - [x] 各献立カード表示（MenuCardコンポーネント）
  - [x] 空の状態（献立なし）の表示（EmptyMenuコンポーネント）
- [x] データ取得・表示（モックデータで実装）
  - [ ] 認証済みユーザーのデータのみ取得（現在はモックのみ）
  - [x] ローディング状態管理
  - [ ] エラーハンドリング（401エラー時はログアウト）

##### 2. ドラッグ&ドロップ機能

- [ ] ドラッグ&ドロップライブラリ選定・導入
  - [ ] `react-native-draggable-flatlist` or `react-native-reanimated`
- [ ] ドラッグ可能なリスト実装
- [ ] ドラッグ時のアニメーション
- [ ] ドロップ時のロジック実装
  - [ ] sortOrder 更新
  - [ ] dayOfWeek 自動計算（位置→曜日変換）
  - [ ] 複数レコード一括更新
- [ ] 楽観的更新（Optimistic UI）実装
- [ ] エラー時のロールバック処理

##### 3. 献立追加・編集画面

- [ ] 画面レイアウト作成
- [ ] フォーム実装
  - [ ] 料理名入力（必須）
  - [ ] メモ入力（任意）
  - [ ] 食事タイプ選択（朝・昼・夜・間食）
- [ ] バリデーション実装
  - [ ] 料理名の必須チェック
  - [ ] 文字数制限
- [ ] 保存処理
  - [ ] 新規作成 / 編集の分岐
  - [ ] DBへの保存
  - [ ] 保存成功時の画面遷移
- [ ] キャンセル処理

##### 4. 献立詳細画面

- [ ] 画面レイアウト作成
- [ ] 献立情報表示
  - [ ] 曜日表示
  - [ ] 料理名
  - [ ] メモ
  - [ ] 食事タイプ
- [ ] 編集ボタン実装
- [ ] 削除ボタン実装
  - [ ] 削除確認ダイアログ
  - [ ] 削除処理

#### 共通コンポーネント

- [ ] 献立カードコンポーネント
- [ ] ローディングコンポーネント
- [ ] エラー表示コンポーネント
- [ ] ボタンコンポーネント
- [ ] 入力フォームコンポーネント

### オフライン機能実装

- [ ] ネットワーク状態監視
  - [ ] `NetInfo` ライブラリ導入
  - [ ] オンライン/オフライン判定
- [ ] ローカルレプリカでの動作確認
- [ ] オフライン時のデータ操作
  - [ ] ローカルDBへの保存
  - [ ] 同期待ちキューの管理
- [ ] オンライン復帰時の同期処理
  - [ ] Turso Sync 設定
  - [ ] 同期完了通知
  - [ ] コンフリクト解決（基本戦略）

### 状態管理

- [ ] TanStack Query セットアップ
  - [ ] @tanstack/react-query インストール
  - [ ] QueryClient 設定
  - [ ] オフライン対応 persister 設定
- [ ] React state での状態管理実装
- [ ] カスタムフック作成
  - [ ] `useMenus()` - 献立一覧取得
  - [ ] `useMenu()` - 献立詳細取得
  - [ ] `useCreateMenu()` - 献立作成
  - [ ] `useUpdateMenu()` - 献立更新
  - [ ] `useDeleteMenu()` - 献立削除
  - [ ] `useReorderMenus()` - 並び替え

### テスト実装

- [ ] ユーティリティ関数のテスト
  - [ ] 曜日計算ロジック
  - [ ] sortOrder ↔ dayOfWeek 変換
- [ ] データベース操作のテスト
  - [ ] CRUD操作
  - [ ] 並び替えロジック
- [ ] コンポーネントのテスト（主要なもののみ）
  - [ ] 献立カードコンポーネント
  - [ ] フォームバリデーション

---

## Phase 3: テスト・改善（2週間）

### バグフィックス

- [ ] 実機テスト（iOS）
  - [ ] iPhone での動作確認
  - [ ] 各種画面サイズでの表示確認
- [ ] バグ一覧作成・修正
- [ ] エッジケースの対応
  - [ ] 献立0件の場合
  - [ ] ネットワークエラー時
  - [ ] データ同期失敗時

### パフォーマンス最適化

- [ ] リスト描画の最適化
  - [ ] FlatList の最適化設定
  - [ ] メモ化（React.memo, useMemo）
- [ ] データベースクエリの最適化
  - [ ] インデックス活用
  - [ ] 不要なクエリ削減
- [ ] ドラッグ&ドロップのパフォーマンス改善
  - [ ] アニメーションの最適化
  - [ ] 一括更新の効率化

### ユーザビリティ改善

- [ ] UIデザインの見直し
  - [ ] 余白・サイズ調整
  - [ ] カラースキーム調整
- [ ] フィードバック改善
  - [ ] トースト通知追加
  - [ ] ローディング状態の改善
  - [ ] エラーメッセージの改善
- [ ] 操作性の改善
  - [ ] ドラッグ&ドロップの操作感
  - [ ] フォーム入力の快適性

---

## Phase 4: リリース準備（1週間）

### App Store申請準備

- [ ] アプリアイコン作成
- [ ] スプラッシュスクリーン作成
- [ ] アプリ名の最終決定
- [ ] App Store用スクリーンショット撮影
- [ ] アプリ説明文作成（日本語）
- [ ] プライバシーポリシー作成
- [ ] Apple Developer Program 登録確認

### ビルド設定

- [ ] iOS ビルド設定
  - [ ] `app.json` / `app.config.js` 設定
  - [ ] Bundle Identifier 設定
  - [ ] バージョン番号設定
- [ ] EAS Build 設定（Expo Application Services）
  - [ ] `eas.json` 設定
  - [ ] ビルドプロファイル作成
- [ ] 本番ビルド実行
  - [ ] iOS App Store用ビルド

### ドキュメント整備

- [ ] README.md 更新
  - [ ] プロジェクト概要
  - [ ] セットアップ手順
  - [ ] 開発手順
- [ ] CHANGELOG.md 作成
- [ ] 開発ドキュメント整理

### リリース

- [ ] App Store Connect にアップロード
- [ ] ベータテスト（TestFlight）
  - [ ] 内部テスター招待
  - [ ] フィードバック収集・対応
- [ ] App Store 審査申請
- [ ] 審査対応
- [ ] 正式リリース

---

## 将来追加予定機能（Phase 5以降）

### 優先度：高

- [ ] ソーシャルログイン機能
  - [ ] Google OAuth 設定
    - [ ] Google Cloud Console でクライアントID取得
    - [ ] OAuth同意画面設定
    - [ ] リダイレクトURI設定
  - [ ] Apple OAuth 設定
    - [ ] Apple Developer でサービスID作成
    - [ ] Sign in with Apple 設定
  - [ ] ログイン画面にボタン追加
- [ ] ゲストからアカウント移行機能
  - [ ] ゲストユーザーのデータを正式アカウントに紐付け
  - [ ] データマイグレーション処理
  - [ ] アカウント作成後の自動ログイン
- [ ] 画像アップロード機能
  - [ ] 料理写真の撮影・選択
  - [ ] 画像ストレージ（Turso Cloudまたは別サービス）
  - [ ] 画像表示・削除
- [ ] 買い物リスト生成機能
  - [ ] 献立から食材抽出
  - [ ] 買い物リスト画面
  - [ ] チェック機能

### 優先度：中

- [ ] プッシュ通知機能
  - [ ] 献立リマインダー
  - [ ] 通知設定画面
- [ ] データ共有機能
  - [ ] 家族・友人との共有
  - [ ] 招待機能
- [ ] レシピ保存機能
  - [ ] 献立にレシピを紐付け
  - [ ] レシピ詳細画面

### 優先度：低

- [ ] データエクスポート機能
  - [ ] CSV出力
  - [ ] PDF出力

### プラットフォーム拡張

- [ ] Android対応
  - [ ] Androidビルド設定
  - [ ] Android固有の調整
  - [ ] Google Play Store リリース
- [ ] Web版開発（Next.js）
  - [ ] モノレポ構成への移行
  - [ ] 共通ロジック層の分離
  - [ ] Web版UI実装

---

## 継続タスク

### 定期メンテナンス

- [ ] 依存パッケージのアップデート
- [ ] セキュリティ脆弱性チェック
- [ ] Turso Cloud の状態監視
- [ ] バックアップ戦略の検討・実装

### ユーザーフィードバック対応

- [ ] フィードバック収集の仕組み
- [ ] 改善要望の管理
- [ ] 優先順位付け・実装

---

## メモ・注意事項

### 技術的な課題

- ドラッグ&ドロップの実装が最も複雑になる可能性あり
- オフライン同期のテストを十分に行う必要あり
- Turso Cloudの無料枠の制限を確認すること

### 開発時の注意

- こまめにコミットすること
- テストを書きながら開発すること
- パフォーマンスを意識した実装を心がけること
